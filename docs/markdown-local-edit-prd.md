# Markdown 局部编辑工具 - 简化版 PRD

## 1. 背景与目标

### 1.1 背景

在长文写作或技术文档场景中，用户经常希望对已有 Markdown 文档中的某一小段内容进行精细修改（例如：重写一个段落、润色一句话、修正一段代码说明），而不是让 LLM 重写整篇文档。

现有多数产品要么只能整体改写，要么局部编辑体验较差（需要手动复制粘贴、容易破坏原有格式）。

### 1.2 产品目标

提供一个面向 Markdown 文档的 **局部 AI 编辑工具**，实现：

- 支持对文档中的某一段/某一句进行选中。
- 用户用自然语言描述"如何修改这部分"。
- LLM 只对这部分进行修改，并保持其余内容与格式不变。
- 所有 AI 操作均有可追溯的对话记录。

## 2. 用户场景 / User Stories

1. **US-01：局部润色**

   - 作为用户，我在一篇技术博客中选中一个段落，输入"改写为更口语化的表达"，系统只改写该段落，其余内容保持不变。

2. **US-02：纠正错误**

   - 作为用户，我选中某段带有错误的说明，输入"修正事实错误，并保持客观语气"，系统只替换该段的内容。

3. **US-03：保持上下文风格**

   - 作为用户，我希望局部修改后的内容风格与原文一致，不显得突兀。

4. **US-04：回顾历史修改**

   - 作为用户，我希望在左侧看到每一次"局部修改请求"和"AI 回复"的历史，方便回顾和复制。

5. **US-05：版本回退**
   - 作为用户，我希望能看到每次修改的前后对比，并能回退到之前的任何一个版本。

## 3. 产品范围（MVP）

### 3.1 在范围内

1. **Markdown 文本局部编辑**
   - 仅支持对 Markdown 文档进行局部修改（不考虑富媒体、复杂交互组件）。
2. **单文档上下文**
   - 当前只支持对单个文档的编辑，不涉及多文档关联。
3. **基础对话记录**
   - 左侧记录简单的问答列表（时间 + 用户请求 + AI 回复简要标题）。
4. **单模型调用**
   - 先支持一种模型（如 OpenAI），不做多模型切换 UI。
5. **版本历史管理**
   - 支持查看和切换不同版本的文档状态。

### 3.2 不在范围内（可作为后续迭代）

- 文档版本对比视图（Diff 可视化）。
- 多人协同编辑。
- 模型选择、温度等高级参数配置。
- 复杂的文档结构（如"模块化多文件项目"）。
- 流式输出（Streaming）UI。

## 4. 核心功能需求

### F-01 渲染 Markdown 文档

**优先级：P0**

- 能够加载并渲染一篇 Markdown 文档。
- 支持基础的 Markdown 特性：标题、段落、列表、代码块、引用、表格等。
- 文档是**可编辑**或至少可选中的（支持选区）。
- 渲染器需要能够将 Markdown 转换为块（Block）结构，方便后续替换。

### F-02 选区识别与绑定

**优先级：P0**

- 用户能用鼠标在文档中选中一段文本（允许跨行选中）。
- 系统能够判断选区是否属于文档内容区域。
- 系统为选区关联：
  - `selectedText`：纯文本内容。
  - `markdownBlock`：选区所在的完整 Markdown 块。
  - `blockId`：选区所在块的唯一标识符（用于精确替换）。
  - `fullMarkdown`：整篇文档的当前版本。
- 选区高亮显示（半透明背景色）。

### F-03 选中后弹出输入框

**优先级：P0**

- 在选区附近展示悬浮输入框（Selection Box）：
  - 包含一个文本输入区域（用户填写"如何修改这段话"）。
  - 包含"确认/取消"按钮。
  - 输入框位置自适应（避免超出可视区域）。
- 输入框关闭条件：
  - 用户点击确认完成请求。
  - 用户点击取消或点击文档其他区域。
  - 用户按 ESC 键。
  - 新选区产生时自动关闭旧输入框。

### F-04 向 LLM 提交局部修改请求

**优先级：P0**

- 请求体至少包含：
  - `selectedText`：用户选中的原文。
  - `markdownBlock`：包含该选区的 block。
  - `fullMarkdown`：整个文档内容（可选，用于风格参考）。
  - `userInstruction`：用户在输入框内的指令。
- Prompt 需严格约束：
  - 只允许返回**一个完整的 Markdown 块**（替代 `markdownBlock`）。
  - 不得插入额外说明文本或多余标记（如"Here's your updated text:"、```markdown 等）。
  - 不得改变除选中内容外的其它部分，除非为保证语义连贯所必需。
- 加载状态提示：请求期间禁用编辑器，显示 Loading 指示器。

### F-05 LLM 返回结果的应用

**优先级：P0**

- 系统接收 LLM 回复后：
  - 将 `fullMarkdown` 中原有的 `markdownBlock` 替换为新 block。
  - 使用 `blockId` 定位精确替换（优先），避免多次出现相同内容时误替换。
  - 更新文档渲染区域，使用户看到实时变化。
  - 将新版本加入版本历史栈。
- 替换过程必须保证：
  - 不破坏其他 block 结构。
  - 不影响未选中部分的格式和内容。
  - 保持文档的可编辑状态。

### F-06 对话记录列表

**优先级：P1**

- 在界面左侧展示对话列表：
  - 每条记录至少包含：
    - 时间戳（相对时间 + 精确时间 tooltip）。
    - 用户指令摘要（最多 2 行，超出显示省略号）。
    - 选中内容预览（最多 1 行）。
    - 点击可展开查看完整内容。
  - 支持折叠/展开所有记录。
- 点击历史记录，可查看：
  - 当时的完整请求内容。
  - AI 回复的完整内容。
  - 修改前后的文本对比（可选）。

### F-07 版本历史管理

**优先级：P1**

- 每次局部修改后，自动保存新版本到历史栈。
- 文档顶部提供版本切换控件：
  - `[← 上一版]` `[下一版 →]`
  - 显示当前版本号（如 "3/8"）。
- 切换版本时：
  - 编辑器内容立即更新为该版本的完整文档。
  - 对话记录列表标记出该版本对应的修改操作。
- 版本数据结构应包含：
  - 版本号（递增）。
  - 完整的 Markdown 内容。
  - 关联的历史记录 ID（如果有）。
  - 时间戳。

## 5. 非功能需求

### 5.1 性能

- **响应时间**：单次局部修改请求在网络和模型正常情况下，期望 5 秒内完成。
- **渲染性能**：文档超过 5000 字时，选区高亮和输入框弹出延迟 < 100ms。
- **版本切换**：版本切换响应时间 < 200ms。

### 5.2 可靠性

- **异常处理**：
  - 如果 LLM 返回格式异常（比如多段文本、带前后说明），前端应给予提示而不是直接替换。
  - 网络请求失败时，保留用户输入，允许重试。
  - 关键操作（如替换文档内容）失败时，自动回滚到上一版本。
- **数据持久化**：
  - 文档内容和历史记录定期自动保存到本地存储（localStorage/IndexedDB）。
  - 页面刷新后能恢复到最后编辑状态。

### 5.3 可用性

- **键盘快捷键**：
  - `ESC`：关闭选区输入框。
  - `Ctrl/Cmd + Z`：撤销到上一版本。
  - `Ctrl/Cmd + Shift + Z`：重做到下一版本。
- **无障碍**：
  - 所有交互元素支持键盘导航。
  - 提供合理的 ARIA 标签。

### 5.4 安全性

- 所有文档内容只在本地或配置的后端中处理，不做额外分享。
- API Key 等敏感信息不在前端硬编码。

## 6. 技术约束

### 6.1 前端技术栈

- 框架：**Vue 3 (Composition API)** + TypeScript
- 构建工具：Vite
- 状态管理：Pinia
- UI 组件库：Element Plus / Naive UI（可选）
- Markdown 编辑器：TipTap + TipTap Markdown Extension

### 6.2 后端接口约定

后端需提供统一的 REST API：

```
POST /api/markdown/edit
Content-Type: application/json

Request Body:
{
  "selectedText": string,
  "markdownBlock": string,
  "fullMarkdown": string,
  "instruction": string
}

Response:
{
  "success": boolean,
  "updatedBlock": string,
  "error"?: string
}
```

## 7. 成功指标

### 7.1 功能完成度

- [ ] 用户能成功选中文档中的任意段落/句子。
- [ ] 用户能通过自然语言指令触发局部修改。
- [ ] 修改结果只影响选中部分，其余内容保持不变。
- [ ] 用户能查看完整的修改历史记录。
- [ ] 用户能在不同版本间自由切换。

### 7.2 用户体验指标

- 用户完成"对指定段落进行 AI 改写"的时间 < 手动复制/粘贴改写的时间。
- 用户对"局部修改结果符合预期"的主观评分 ≥ 4/5。
- 核心操作流程（选中 → 输入指令 → 查看结果）的点击次数 ≤ 3 次。

### 7.3 技术指标

- 单元测试覆盖率 ≥ 70%（核心逻辑函数）。
- E2E 测试覆盖所有主流程。
- 无严重安全漏洞（如 XSS、CSRF）。

## 8. 里程碑规划

### Phase 1: MVP 核心功能（2-3 周）

- [x] 基础 Markdown 渲染
- [x] 选区识别与高亮
- [x] 选区输入框 UI
- [x] LLM API 集成
- [x] 局部替换逻辑

### Phase 2: 历史与版本（1-2 周）

- [ ] 对话记录列表
- [ ] 版本历史栈
- [ ] 版本切换 UI
- [ ] 本地持久化

### Phase 3: 体验优化（1 周）

- [ ] 键盘快捷键
- [ ] 异常处理完善
- [ ] 加载状态优化
- [ ] 响应式布局适配

## 9. 风险与依赖

### 9.1 技术风险

- **Markdown 块识别准确性**：复杂嵌套结构（如列表中的代码块）可能导致块边界识别不准。

  - 缓解措施：使用成熟的 Markdown AST 解析库（如 remark）。

- **选区跨块问题**：用户选中内容跨越多个 Markdown 块时的处理逻辑。
  - 缓解措施：V1 版本限制只能选中单个块内的内容，给予友好提示。

### 9.2 外部依赖

- **LLM API 稳定性**：依赖第三方 LLM 服务的可用性和响应速度。

  - 缓解措施：实现超时重试机制，允许用户配置多个模型备选。

- **浏览器兼容性**：`window.getSelection()` 等 API 在不同浏览器的表现差异。
  - 缓解措施：只支持现代浏览器（Chrome/Edge/Safari 最近 2 个版本）。

## 10. 未来规划

### 10.1 短期优化（3-6 个月）

- 支持流式输出（Streaming），实时显示 LLM 生成过程。
- 提供 Diff 可视化，高亮显示修改前后的差异。
- 增加多模型切换（OpenAI / Anthropic / 本地模型）。

### 10.2 长期愿景（6-12 个月）

- 多文档协同编辑支持。
- 智能建议：根据上下文主动推荐可优化的段落。
- 插件生态：允许第三方开发自定义 Markdown 处理插件。
